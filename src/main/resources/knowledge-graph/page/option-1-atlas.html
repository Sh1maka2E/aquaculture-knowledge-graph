<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>智慧水产养殖知识图谱查询</title>
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="../css/my-element-ui.css">
    <link rel="icon" href="../logo.svg">
</head>

<style>
    .el-main {
        background-color: #161b22;
        color: #8b949e;
        margin-left: 20px;
        margin-right: 20px;
        /*line-height: 60px;*/
        padding: 0px;
    }

    .el-container {
        padding: 0px;
        margin: 0px;
        background-color: #161b22;
        border-bottom: 1px solid #7ee787;
        border-left: 1px solid #7ee787;
        border-right: 1px solid #7ee787;
        color: #8b949e;
        line-height: 60px;
        padding: 0px;
    }

    html, body, #app {
        padding: 0px;
        margin: 0px;
        height: 100%;
    }

</style>
<body>
<el-main id="app" style="display: none;" :style="{display: 'block'}">
    <el-container style="height: 100%">
        <el-header style="text-align: center; font-size: 24px; text-align: left; ">
            <span>智慧水产养殖知识图谱查询</span>
        </el-header>

        <div style="height: 60px; background-color: #161b22">
            <template>
                <el-select name="head" id="head" @change="headChange" v-model="selectedHead"
                           filterable placeholder="请选择head"
                           style="width: 400px; margin-left: 100px;">
                    <el-option
                            v-for="(item,index) in head" v-bind:value="item">{{item}}
                    </el-option>
                </el-select>
                <el-select name="relation" id="relation" v-model="selectedRelation"
                           filterable placeholder="请选择relation"
                           style="width: 400px; margin-left: 100px; margin-right: 100px">
                    <el-option
                            v-for="(item,index) in relation" v-bind:value="item">{{item}}
                    </el-option>
                </el-select>
            </template>
            <el-button @click="searchGraph" icon="el-icon-search">查询知识图谱</el-button>
        </div>

        <!--知识图谱 -->
        <el-main>
            <div id="graph" style="width: 100%;height:100%;"></div>
            <!-- 节点信息表单 -->
            <el-dialog title="节点信息" :visible.sync="dialogTableVisible">
<!--                <el-table :data="gridData" >-->
<!--                    <el-table-column v-for="(key,value) in gridData" :property = "value" :label = "key" width="150"></el-table-column>-->
<!--                </el-table>-->
                <p v-for="(value,key) in gridData" :key="key" :value="value">{{key}}:{{value}}</p>
            </el-dialog>
        </el-main>

    </el-container>

    </div>

</body>
<script src="../plugins/vue/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="../plugins/axios/axios.min.js"></script>
<script src="/neo4j/js/echarts.common.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@4.5.0/dist/echarts.min.js"></script>


<script>
    const app = new Vue({
        el: "#app",
        data: {
            selectedHead: "",
            selectedRelation: "",
            head: [],
            relation: [],
            triplet: [],
            gridData: [],
            dialogTableVisible: false,
            formLabelWidth: '120px'
        },
        created() {
            this.getHeads()
        },
        methods: {
            getHeads() {
                axios.get("http://localhost:8080/neo4j/getHeads")
                    .then(({data}) => {
                        console.log(data)
                        this.head = data;
                    })
                    .catch(err => {
                        this.$message.error(err)
                    })
            },
            headChange(val) {
                this.relation = ''
                this.selectedRelation = ''
                axios.get("http://localhost:8080/neo4j/getRelationsWithoutRepetition/" + val)
                    .then(({data}) => {
                        this.relation = data;
                    })
                    .catch(err => {
                        this.$message.error(err)
                    })
            },
            searchGraph() {
                if (this.selectedHead === '' && this.selectedRelation === '') {
                    console.log("head和relation都为空")
                    axios.get("http://localhost:8080/neo4j/getRelations/")
                        .then(({data}) => {
                            console.log(data)
                            this.triplet = data;
                            this.draw(data);
                        })
                        .catch(err => {
                            this.$message.error("数据异常")
                        })
                } else if (this.selectedHead !== '' && this.selectedRelation === '') {
                    console.log("relation为空")
                    axios.get("http://localhost:8080/neo4j/getRelations/" + this.selectedHead)
                        .then(({data}) => {
                            console.log(data)
                            this.triplet = data;
                            this.draw(data);
                        })
                        .catch(err => {
                            this.$message.error("数据异常")
                        })
                } else if (this.selectedHead !== '' && this.selectedRelation !== '') {
                    console.log("head和relation都不为空")
                    axios.get("http://localhost:8080/neo4j/getRelations/" + this.selectedHead + '/' + this.selectedRelation)
                        .then(({data}) => {
                            console.log(data)
                            this.triplet = data;
                            this.draw(data);
                        })
                        .catch(err => {
                            this.$message.error("数据异常")
                        })
                }
            },
            searchNode(name) {
                axios.get("http://localhost:8080/neo4j/getHead/" + name)
                    .then(({data}) => {
                        this.gridData = data;
                        console.log(this.gridData)
                        this.dialogTableVisible = true;
                    })
                    .catch(err => {
                        this.$message.error("数据异常")
                    })
            },
            draw(triplet) {
                var myChart = echarts.init(document.getElementById('graph'));
                var myNodes = []
                var myLinks = []
                var set = new Set();
                for (let i = 0; i < triplet.length; i++) {
                    set.add(triplet[i].startNode)
                    set.add(triplet[i].endNode)
                }
                set.forEach(function (element) {
                    var node = {
                        "name": element
                    }
                    myNodes.push(node)
                })

                for (let i = 0; i < triplet.length; i++) {
                    var link = {
                        "source": triplet[i].startNode,
                        "target": triplet[i].endNode,
                        "value": triplet[i].relation,
                        "symbolSize": 10
                    }
                    myLinks.push(link)
                }
                var option = {
                    title: {
                        text: ''
                    },
                    tooltip: {},
                    animationDurationUpdate: 1500,
                    animationEasingUpdate: 'quinticInOut',
                    label: {
                        normal: {
                            show: true,
                            textStyle: {
                                fontSize: 20
                            },
                        }
                    },
                    legend: {
                        x: "center",
                        show: false
                    },
                    // 工具箱
                    toolbox: {
                        // 显示工具箱
                        show: true,
                        feature: {
                            mark: {
                                show: true
                            },
                            // 还原
                            restore: {
                                show: true
                            },
                            // 保存为图片
                            saveAsImage: {
                                show: true
                            }
                        }
                    },
                    series: [
                        {
                            type: 'graph',
                            layout: 'force',
                            symbolSize: 45,
                            focusNodeAdjacency: true,
                            roam: true,
                            edgeSymbol: ['none', 'arrow'],
                            categories: [{
                                name: '查询实体',
                                itemStyle: {
                                    normal: {
                                        color: "#009800",
                                    }
                                }
                            }, {
                                name: 'instance',
                                itemStyle: {
                                    normal: {
                                        color: "#4592FF",
                                    }
                                }
                            }, {
                                name: 'class',
                                itemStyle: {
                                    normal: {
                                        color: "#C71585",
                                    }
                                }
                            }],
                            label: {
                                normal: {
                                    show: true,
                                    textStyle: {
                                        // 节点文本颜色
                                        // color: "#75bfff",
                                        // color: "#e8c140",
                                        color: "#ffffff",
                                        fontSize: 18,
                                    },
                                }
                            },
                            force: {
                                repulsion: 1000
                            },
                            edgeSymbolSize: [4, 50],
                            edgeLabel: {
                                normal: {
                                    show: true,
                                    textStyle: {
                                        fontSize: 18
                                    },
                                    formatter: "{c}"
                                }
                            },
                            data: myNodes,
                            links: myLinks,
                            itemStyle: {
                                normal: {
                                    color: function () {
                                        // 节点颜色
                                        return "#f16667"
                                    },
                                }
                            },
                            lineStyle: {
                                normal: {
                                    opacity: 0.9,
                                    width: 1.3,
                                    curveness: 0,
                                    symbolSize: 10,
                                    // 关系线颜色
                                    color: "#7ee787",
                                }
                            }
                        }
                    ]
                };
                // 使用刚指定的配置项和数据显示图表。
                myChart.setOption(option);
                // 点击事件
                var _this = this
                myChart.on('click', function (param){
                    if (param.dataType == 'node') {
                        // this.clickNode = param.name;
                        _this.searchNode(param.name)
                        console.log('点击节点:', param.name);
                    } else {
                        console.log('点击关系:', param.value);
                    }
                });
            }
        }
    })
</script>
</html>

